# ç°ä»£åŒ…ç®¡ç†å™¨ - ä»npmã€yarnåˆ°pnpm
## javascript åŒ…ç®¡ç†çš„å†å²

- npm å‡ºç°ä¹‹å‰ï¼šå‰ç«¯ä¾èµ–é¡¹æ˜¯ä¿å­˜åˆ°å­˜å‚¨åº“ä¸­å¹¶æ‰‹åŠ¨ä¸‹è½½çš„ ğŸ“
- 2010ï¼šnpm å‘å¸ƒå¹¶æ”¯æŒ nodejsğŸ“¦
- 2012ï¼šnpm çš„ä½¿ç”¨é‡æ€¥å‰§å¢åŠ â€”â€”ä¸»è¦æ˜¯ç”±äº Browserifys æµè§ˆå™¨çš„æ”¯æŒ ğŸ‰
- 2012ï¼šnpm æœ‰äº†ä¸€ä¸ªç«äº‰å¯¹æ‰‹ bowerï¼Œå®ƒå®Œå…¨æ”¯æŒæµè§ˆå™¨ ğŸ’»
- 2012-2016ï¼šå‰ç«¯é¡¹ç›®çš„ä¾èµ–é¡¹æ•°é‡æˆå€å¢åŠ  ğŸ¤¯
- 2012-2016ï¼šæ„å»ºå’Œå®‰è£…å‰ç«¯åº”ç”¨å˜å¾—è¶Šæ¥è¶Šæ…¢ ğŸ¢
- 2012-2016ï¼šå¤§é‡ï¼ˆé‡å¤çš„ï¼‰ä¾èµ–é¡¹å­˜å‚¨åœ¨ç¥å¥‡çš„ node_modules å†…çš„åµŒå¥—æ–‡ä»¶å¤¹ä¸­ â˜¢ï¸
- 2012-2016ï¼šrm -rf node_modules æˆä¸ºå‰ç«¯å¼€å‘äººå‘˜æœ€å¸¸ç”¨çš„å‘½ä»¤ã€‚ ğŸ—‘
- 2015ï¼šbower è¾“ç»™äº† npm ğŸ’€
- 2015ï¼šnode_modules è¢«ä¿®æ”¹ä¸ºæ‰å¹³åŒ–çš„æ–‡ä»¶ç»“æ„ï¼ ğŸ•¸
- 2016ï¼š left-pad æˆä¸ºå½“æ—¶çš„æ–°é—»å¤´æ¡ ğŸ‘ˆ
- 2016ï¼š yarn å‘å¸ƒ ğŸš€
  - æ”¯æŒ npm å’Œ bower ä»“åº“
  - yarn.lock èƒ½å¤Ÿé”å®šå®‰è£…çš„ç‰ˆæœ¬å¹¶æä¾›ç¡®å®šæ€§çš„ä¾èµ–å…³ç³»ã€‚ä¸å† rm -rf - node_modulesï¼
  - yarn install èŠ±è´¹çš„æ—¶é—´æ˜¯ npm install çš„ä¸€åŠï¼ˆä¸ä½¿ç”¨ç¼“å­˜çš„å‰æä¸‹ï¼‰
  - ç¼“å­˜å’Œè„±æœºæ¨¡å¼ä½¿æ„å»ºè¿‡ç¨‹å‡ ä¹ä¸èŠ±è´¹æ—¶é—´
- 2016ï¼šnpm å‘å¸ƒ shrinkwrapğŸ§¯
  - å°è¯•å¤„ç†ä¾èµ–é¡¹é”å®š
  - ä¸å¹¸çš„æ˜¯ï¼Œä¸€äº›é”™è¯¯å’Œè¶…å‡ºå…¶ç®¡ç†èƒ½åŠ›çš„æ‰¿è¯ºå¯¼è‡´è¯¥å·¥å…·çš„å£°èª‰ä¸‹é™
- 2017ï¼šnpm 5 å‘å¸ƒ ğŸ”“
  - package-lock.json æ˜¯ä»–ä»¬çš„æ–°å·¥å…·ï¼Œshrinkwrap è¢«æ”¾åœ¨ä¸€è¾¹
  - package-lock.json å¼€å§‹ä¸ yarns é”å®šæ–‡ä»¶ç«äº‰
- 2018ï¼šnpm ci å‘å¸ƒ ğŸ›¬
  - ç›´æ¥ç”¨ package-lock.json æ„å»ºä»£ç 
  - æ²¡æœ‰ä»£ä»·é«˜æ˜‚çš„ä¾èµ–é¡¹å®‰å…¨æ€§åˆ†æå’Œç‰ˆæœ¬åˆ†æ
  - å¤§å¤§å‡å°‘äº†åœ¨æ„å»ºæœåŠ¡å™¨ä¸Šçš„æ„å»ºæ—¶é—´ï¼
- 2018ï¼šnpm 6 å‘å¸ƒ ğŸ‘®â€â™€ï¸
  - npm æ£€æŸ¥è¦å®‰è£…çš„ä¾èµ–é¡¹ä¸­çš„å®‰å…¨æ¼æ´
  - yarn å’Œ npm çš„æ„å»ºæ—¶é—´ä¸å†æœ‰æ˜¾å·®å¼‚
- ...

## npm/yarn å›é¡¾

### npm v2

åœ¨æœ€æ—©æœŸçš„`npm`ç‰ˆæœ¬(npm v2)ï¼Œ`npm`çš„è®¾è®¡å¯ä»¥è¯´æ˜¯éå¸¸çš„ç®€å•,åœ¨å®‰è£…ä¾èµ–çš„æ—¶å€™ä¼šå°†ä¾èµ–æ”¾åˆ°` node_modules`æ–‡ä»¶ä¸­; éšç€é¡¹ç›®çš„ä¸æ–­å¢å¤§ï¼Œä¾èµ–é€æ¸å˜æˆä¸€ä¸ªå·¨å¤§çš„ä¾èµ–æ ‘ï¼Œä¸åŒä¾èµ–ä¹‹é—´é‡å¤çš„ä¾èµ–åŒ…ä¹Ÿä¼šé‡å¤å®‰è£…ï¼Œæ—¢å ç”¨æˆ‘ä»¬ç”µè„‘å†…å­˜ï¼Œä¹Ÿåœ¨å®‰è£…/åˆ é™¤çš„è¿‡ç¨‹ä¸­å˜å¾—æä¸ºç¼“æ…¢ï¼Œ å½¢æˆ`åµŒå¥—åœ°ç‹±`

> æ¯”å¦‚ä½ å®‰è£…ä¸€ä¸ª expressï¼Œé‚£ä¹ˆä½ ä¼šåœ¨ node_modules ä¸‹é¢åªæ‰¾åˆ°ä¸€ä¸ª express çš„æ–‡ä»¶å¤¹ã€‚è€Œ express ä¾èµ–çš„é¡¹ç›®éƒ½æ”¾åœ¨å…¶æ–‡ä»¶å¤¹ä¸‹ã€‚

```
- app/
  - package.json
  - node_modules/
    - express/
      - index.js
      - package.json
      - node_modules/
        - ...
```

è¿™ä¸ªå¸¦æ¥çš„é—®é¢˜æˆ–è®¸ windows ç”¨æˆ·æ·±è°™å…¶ç—›ï¼Œå› ä¸ºåœ¨è¿™ç§å®‰è£…ç¯å¢ƒä¸‹ï¼Œä¼šå¯¼è‡´ç›®å½•çš„å±‚çº§ç‰¹åˆ«é«˜ï¼Œè€Œå¯¹äº windows æ¥è¯´ï¼Œæœ€å¤§çš„è·¯å¾„é•¿åº¦é™åˆ¶åœ¨ 248 ä¸ªå­—ç¬¦(æ›´å¤šè¯·è§æ­¤)ï¼Œå†åŠ ä¸Š node_modules è¿™ä¸ªå•è¯åˆç‰¹åˆ«é•¿ï¼Œ

### npm v3

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ(npm v3)é‡æ–°è€ƒè™‘äº† node_modules ç»“æ„å¹¶æå‡ºäº†æ‰å¹³åŒ–ã€‚å¯ä»¥è¯´å¾ˆå¥½çš„è§£å†³äº†åµŒå¥—å±‚çº§è¿‡æ·±ä»¥åŠå®ä¾‹ä¸å…±äº«çš„é—®é¢˜ã€‚
æ‰€æœ‰çš„ä¾èµ–éƒ½è¢«æ‹å¹³åˆ°`node_modules`ç›®å½•ä¸‹ï¼Œä¸å†æœ‰å¾ˆæ·±å±‚æ¬¡çš„åµŒå¥—å…³ç³»ã€‚è¿™æ ·åœ¨å®‰è£…æ–°çš„åŒ…æ—¶ï¼Œæ ¹æ® node require æœºåˆ¶ï¼Œä¼šä¸åœå¾€ä¸Šçº§çš„`node_modules`å½“ä¸­å»æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ç›¸åŒç‰ˆæœ¬çš„åŒ…å°±ä¸ä¼šé‡æ–°å®‰è£…ï¼Œè§£å†³äº†å¤§é‡åŒ…é‡å¤å®‰è£…çš„é—®é¢˜ï¼Œè€Œä¸”ä¾èµ–å±‚çº§ä¹Ÿä¸ä¼šå¤ªæ·±ã€‚

```
- app/
- node_modules/
  - express/
  - connect/
  - path-to-regexp/
  - ...
```

å¦‚æœå‡ºç°äº†ä¸åŒç‰ˆæœ¬çš„ä¾èµ–ï¼Œæ¯”å¦‚è¯´ package-a ä¾èµ– `package-c@0.x.xçš„ç‰ˆæœ¬ï¼Œè€Œpackage-bä¾èµ–package-c@1.x.x` ç‰ˆæœ¬ï¼Œé‚£ä¹ˆè§£å†³æ–¹æ¡ˆè¿˜æ˜¯åƒä¹‹å‰çš„é‚£ç§åµŒå¥—æ¨¡å¼ä¸€æ ·ã€‚

```
- app/
- node_modules/
  - package-a/
  - package-c/
    - // 0.x.x
  - package-b/
    - node_modules/
      - package-c/
        - // 1.x.x
```

ä½†æ˜¯ï¼Œ æ‰å¹³åŒ–çš„æ–¹å¼ä¾ç„¶å­˜åœ¨è¯¸å¤šé—®é¢˜...

### yarn v1

éšç€ node ç¤¾åŒºå£®å¤§, ä¸ºäº†è§£å†³ npm çš„å‡ ä¸ªé—®é¢˜

- æ— æ³•ä¿è¯ä¸¤æ¬¡å®‰è£…çš„ç‰ˆæœ¬æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚
- å®‰è£…é€Ÿåº¦æ…¢ã€‚
- npm æ˜¯ä¸æ”¯æŒç¦»çº¿æ¨¡å¼,å¯¼è‡´å†…ç½‘å›°éš¾

æ‰€ä»¥ï¼Œæ­¤æ—¶ yarn è¯ç”Ÿäº†ï¼Œä¸ºçš„å°±æ˜¯è§£å†³ä¸Šé¢å‡ ä¸ªé—®é¢˜ã€‚

- å¼•å…¥ `yarn.lock` æ–‡ä»¶æ¥ç®¡ç†ä¾èµ–ç‰ˆæœ¬é—®é¢˜ï¼Œä¿è¯æ¯æ¬¡å®‰è£…éƒ½æ˜¯ä¸€è‡´çš„ã€‚
- ç¼“å­˜åŠ å¹¶è¡Œä¸‹è½½ä¿è¯äº†å®‰è£…é€Ÿåº¦

### npm v5

å¯èƒ½æ˜¯å—`yarn`çš„å½±å“, npm v5 å¼•å…¥äº† `package-lock.json` æ¥é”å®šç‰ˆæœ¬, ä¸”è‡ªåŠ¨æ·»åŠ . å¹¶ä¸”æå‡äº†å®‰è£…é€Ÿåº¦, ä½†ä¾ç„¶æ²¡æœ‰ yarn å¿«

### npm v6

åŠ å…¥äº†ç¼“å­˜, è¿›ä¸€æ­¥æå‡äº†é€Ÿåº¦

### yarn v2

2020 å¹´å‘å¸ƒçš„ yarn v2 å¯è°“æ˜¯ yarn çš„ä¸€ä¸ªå·¨å¤§çš„æ”¹å˜
å¢åŠ [Plug'n'Play](https://link.zhihu.com/?target=https%3A//next.yarnpkg.com/features/pnp)èƒ½åŠ›ï¼Œä½œä¸ºé‡å¤´æˆï¼Œç°åœ¨å·²ç»ç›´æ¥å†…ç½®åœ¨ 2.0 ç‰ˆæœ¬é‡Œé¢äº†ã€‚å®˜æ–¹è¯´å¯ä»¥ç”¨ node-modules æ’ä»¶åˆ‡æ¢ï¼Œä½†çœ‹èµ·æ¥å¹¶ä¸èƒ½â€¦â€¦

åœ¨ä½¿ç”¨ yarn 2.x å®‰è£…ä»¥åï¼Œnode_modules ä¸ä¼šå†å‡ºç°ï¼Œä»£æ›¿å®ƒçš„æ˜¯.yarn ç›®å½•ï¼Œé‡Œé¢æœ‰ cache å’Œ unplugged ä¸¤ä¸ªç›®å½•ï¼Œä»¥åŠå¤–é¢ä¸€ä¸ª.pnp.js

- .yarn/cache é‡Œé¢æ”¾æ‰€æœ‰éœ€è¦çš„ä¾èµ–çš„å‹ç¼©åŒ…ï¼Œzip æ ¼å¼
- .yarn/unplugged æ˜¯ä½ éœ€è¦æ‰‹åŠ¨å»ä¿®æ”¹çš„ä¾èµ–ï¼Œä½¿ç”¨ yarn unplugin lodash å¯ä»¥æŠŠ lodash è§£å‹åˆ°è¿™ä¸ªç›®å½•ä¸‹ï¼Œä¹‹åæƒ³ä¿®æ”¹ä»€ä¹ˆçš„éšæ„
- .[pnp.js](https://www.zhihu.com/search?q=pnp.js&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A986919691%7D)æ˜¯ PNP åŠŸèƒ½çš„æ ¸å¿ƒï¼Œæ‰€æœ‰çš„ä¾èµ–å®šä½éƒ½éœ€è¦é€šè¿‡å®ƒæ¥

### ä¸ºä»€ä¹ˆä¼šæœ‰`package-lock.json`ã€`yarn.lock` çš„å‡ºç°

åœ¨`package.json `ä¸­, æˆ‘ä»¬æ–°å¢ä¸€ä¸ªåŒ…éƒ½æ˜¯ä½¿ç”¨ `^` æˆ–è€… `~` çš„æ–¹å¼æ¥å®‰è£…ä¾èµ–.
1ã€å¦‚æœåœ¨ä¸åŒçš„æ—¶é—´å®‰è£…è¿™äº›è½¯ä»¶åŒ…ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´ä¸‹è½½è¿™äº›è½¯ä»¶åŒ…çš„ä¸åŒç‰ˆæœ¬ã€‚
2ã€åœ¨åˆ é™¤äº† `node_modules` æ–‡ä»¶å¤¹å, ä¸å®ç”¨ `lock`  æ–‡ä»¶å®‰è£…çš„æƒ…å†µä¸‹, æ¯æ¬¡å®‰è£…çš„ä¾èµ–éƒ½ä¸ä¸€æ ·
3ã€åœ¨é¡¹ç›®çš„ä¾èµ–ä¸­, æŸä¸ªä¾èµ–ç”±äºä½¿ç”¨ `^` æ–¹å¼, å°†ä¼šå®‰è£…æœ€æ–°çš„å°ç‰ˆæœ¬, è¿™å°†å¯èƒ½å½±å“åˆ°é¡¹ç›®, æ¯”å¦‚ `element-ui@2.12.0` ä¸ä¹‹åçš„ç‰ˆæœ¬çš„ `Transfer ç©¿æ¢­æ¡†` ç»„ä»¶æ ·å¼å°±å®Œå…¨ä¸ä¸€æ ·ç­‰

å› æ­¤ï¼Œæœ‰`package-lock.json`ã€`yarn.lock` çš„å‡ºç°,å°†é¡¹ç›®ä¾èµ–æ¯æ¬¡æ–°å¢ä»¥åŠä¿®æ”¹çš„è¿‡ç¨‹ä¸­, å°†å…³ç³»è®°å½•å›ºå®š.å°±è§£å†³äº†è¿™äº›é—®é¢˜.
ä½†æ˜¯, åƒä¸‡ä¸è¦æ··ç”¨ `npm` å’Œ `yarn`, è¿™å°†å¯¼è‡´å®‰è£…ä¾èµ–ä¿®æ”¹çš„ `lock` æ–‡ä»¶ä¼šè®°å½•åœ¨ä¸åŒçš„åœ°æ–¹, ç›¸å½“äºå„è‡ªè®°å½•ä¸€åŠ.
å»ºè®®æ‚¨æäº¤è€Œä¸åˆ é™¤è¿™äº›æ–‡ä»¶ï¼Œé™¤éæ‚¨æ‰“ç®—æ ¹æ® package.json è§„èŒƒæ›´æ–°è½¯ä»¶åŒ…ï¼Œå¹¶ä¸”å‡†å¤‡è¿›è¡Œå½»åº•çš„æµ‹è¯•æˆ–å¿«é€Ÿä¿®å¤ç”Ÿäº§ä¸­å‘ç°çš„æ‰€æœ‰é”™è¯¯ã€‚

### `node_modules` çš„æ‰å¹³åŒ–ç»“æ„é—®é¢˜

**1ã€æ¨¡å—å¯ä»¥è®¿é—®å®ƒä»¬ä¸ä¾èµ–çš„åŒ…(å¹½çµä¾èµ–)** 
å¯¹äºä¸€ä¸ªå®‰è£…åŒ…å†… `package.json` ä¸­æœªç”³æ˜çš„åŒ…ï¼Œnpm/yarn ç”±äºæ‰å¹³åŒ–çš„åŸå› ï¼Œ å¯ä»¥å€ŸåŠ©å…¶å®‰è£…çš„åŒ…å†…ä½¿ç”¨çš„ä¾èµ–ç›´æ¥ä½¿ç”¨ï¼Œè¿™å¯¹äºç»´æŠ¤æ¥è¯´æåº¦ä¸å®‰å…¨ï¼Œ å½“å…¶ä¾èµ–å»é™¤æˆ–å‡çº§ï¼Œ å°†ä¸å¯æ§
ä¾‹å¦‚ï¼Œä¸€ä¸ªåŠ è½½çš„åŒ…ä¸­ä½¿ç”¨çš„ `moment.js`, éšç€åé¢å¯èƒ½çš„å‡çº§ï¼Œ å‡å¦‚å°†å…¶æ›¿æ¢ä¸º`day.js`,å°†å¯¼è‡´ä»£ç æŠ¥é”™
**2ã€æ‰å¹³åŒ–ä¾èµ–æ ‘çš„ç®—æ³•éå¸¸å¤æ‚**
**3ã€ä¸€äº›åŒ…å¿…é¡»å¤åˆ¶åˆ°ä¸€ä¸ªé¡¹ç›®çš„ node_modules æ–‡ä»¶å¤¹ä¸­**
åœ¨å¾ˆå¤šæ—¶å€™ï¼Œ æˆ‘ä»¬å®‰è£…ä¸€ä¸ªä¾èµ–ï¼Œ åœ¨`node_modules`ä¸­å­˜åœ¨ä¸€å †ä¹±ä¸ƒå…«ç³Ÿçš„ä¾èµ–ï¼Œæåº¦å½±å“æ’æŸ¥é—®é¢˜

## pnpm å‰æ¥æŒ‘æˆ˜

### ä»€ä¹ˆæ˜¯ pnpm

> `pnpm` - é«˜æ€§èƒ½ npm 

**aa**ï¼šæˆ‘ä»¬æ¥YYä¸€ä¸‹æ–°çš„`node_modules`ç»“æ„å§ï¼Œæ€ä¹ˆè®©`node_modules`çœ‹èµ·æ¥æ›´å¹²å‡€å‘¢ï¼Ÿ
**bb**ï¼šæˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº† `react`ã€`@dji/dui` ä¸¤ä¸ªåŒ…ï¼Œèƒ½ä¸èƒ½åœ¨é‡Œé¢åªæ˜¾ç¤ºè¿™ä¸¤ä¸ªåŒ…çš„ä¾èµ–å‘€ï¼
**aa**ï¼šé‚£è¿™ä¸¤ä¸ªåŒ…æ‰€éœ€çš„ä¾èµ–æ€ä¹ˆåŠå‘¢ï¼Ÿ
**bb**ï¼šè¦ä¸æä¸ªéšè—æ–‡ä»¶æ”¾èµ·æ¥ï¼Œå¹¶ä¸”ä¸åµŒå¥—ï¼Œç”¨è½¯é“¾æ¥è¿èµ·æ¥ï¼Œæ¯ä¸ªåŒ…ç”¨ç‰ˆæœ¬å·åŒºåˆ†å¼€å°±å¥½äº†
**aa**ï¼šé‚£æˆ‘ä»¬æ€ä¹ˆè¶…è¿‡ npm/yarn çš„é€Ÿåº¦å‘¢ï¼Ÿ
**bb**ï¼šæˆ‘ä»¬ç”¨ç¡¬é“¾æ¥å§ï¼Œæ—¢é€Ÿåº¦è¶…è¿‡äº†ä»–ä»¬ï¼Œè¿˜çœç£ç›˜ç©ºé—´äº†

### ç‰¹æ€§æ¦‚è§ˆ

**1ã€é€Ÿåº¦å¿«**
pnpm å®‰è£…åŒ…çš„é€Ÿåº¦ç©¶ç«Ÿæœ‰å¤šå¿«ï¼Ÿæˆ‘ä»¬å¯ä»¥ä» `pnpm` çš„å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾åˆ°ç­”æ¡ˆ

| action  | cache | lockfile | node_modules | npm   | pnpm  | Yarn  | Yarn PnP |
| ------- | ----- | -------- | ------------ | ----- | ----- | ----- | -------- |
| install |       |          |              | 51s   | 14.4s | 39.1s | 29.1s    |
| install | âœ”     | âœ”        | âœ”            | 5.4s  | 1.3s  | 707ms | n/a      |
| install | âœ”     | âœ”        |              | 10.9s | 3.9s  | 11s   | 1.8s     |
| install | âœ”     |          |              | 33.4s | 6.5s  | 26.5s | 17.2s    |
| install |       | âœ”        |              | 28.3s | 11.8s | 23.3s | 14.2s    |
| install | âœ”     |          | âœ”            | 4.6s  | 1.7s  | 22.1s | n/a      |
| install |       | âœ”        | âœ”            | 6.5s  | 1.3s  | 713ms | n/a      |
| install |       |          | âœ”            | 6.1s  | 5.4s  | 41.1s | n/a      |
| update  | n/a   | n/a      | n/a          | 5.1s  | 10.7s | 35.4s | 28.3s    |

![Graph of the alotta-files results](https://github.com/pnpm/benchmarks-of-javascript-package-managers/raw/main/results/imgs/alotta-files.svg)

ä»ä¸Šå›¾æ•°æ®ä¸­å¯ä»¥çœ‹å‡ºï¼Œ åœ¨ pnpm é¢å‰ï¼Œ npm å’Œ yarn ä¸€ä¸ªèƒ½æ‰“çš„éƒ½æ²¡æœ‰ã€‚
åœ¨ç»å¤šå¤§æ•°åœºæ™¯ä¸‹ï¼ŒåŒ…å®‰è£…çš„é€Ÿåº¦éƒ½æ˜¯æ˜æ˜¾ä¼˜äº npm/yarnï¼Œé€Ÿåº¦ä¼šæ¯” npm/yarn å¿« 2-3 å€ã€‚

**2ã€é«˜æ•ˆåˆ©ç”¨ç£ç›˜ç©ºé—´**

pnpm å†…éƒ¨ä½¿ç”¨`åŸºäºå†…å®¹å¯»å€`çš„æ–‡ä»¶ç³»ç»Ÿæ¥å­˜å‚¨ç£ç›˜ä¸Šæ‰€æœ‰çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿå‡ºè‰²çš„åœ°æ–¹åœ¨äº:

- ä¸ä¼šé‡å¤å®‰è£…åŒä¸€ä¸ªåŒ…ã€‚ç”¨ npm/yarn çš„æ—¶å€™ï¼Œå¦‚æœ 100 ä¸ªé¡¹ç›®éƒ½ä¾èµ– lodashï¼Œé‚£ä¹ˆ lodash å¾ˆå¯èƒ½å°±è¢«å®‰è£…äº† 100 æ¬¡ï¼Œç£ç›˜ä¸­å°±æœ‰ 100 ä¸ªåœ°æ–¹å†™å…¥äº†è¿™éƒ¨åˆ†ä»£ç ã€‚ä½†åœ¨ä½¿ç”¨ pnpm åªä¼šå®‰è£…ä¸€æ¬¡ï¼Œç£ç›˜ä¸­åªæœ‰ä¸€ä¸ªåœ°æ–¹å†™å…¥ï¼Œåé¢å†æ¬¡ä½¿ç”¨éƒ½ä¼šç›´æ¥ä½¿ç”¨ `hard link`(ç¡¬é“¾æ¥)ã€‚
- å³ä½¿ä¸€ä¸ªåŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œpnpm ä¹Ÿä¼šæå¤§ç¨‹åº¦åœ°å¤ç”¨ä¹‹å‰ç‰ˆæœ¬çš„ä»£ç ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚ lodash æœ‰ 100 ä¸ªæ–‡ä»¶ï¼Œæ›´æ–°ç‰ˆæœ¬ä¹‹åå¤šäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆç£ç›˜å½“ä¸­å¹¶ä¸ä¼šé‡æ–°å†™å…¥ 101 ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¿ç•™åŸæ¥çš„ 100 ä¸ªæ–‡ä»¶çš„ `hard lsink`ï¼Œä»…ä»…å†™å…¥é‚£`ä¸€ä¸ªæ–°å¢çš„æ–‡ä»¶`ã€‚

**3. æ”¯æŒ [monorepo](https://www.perforce.com/blog/vcs/what-monorepo)**


**4. å®‰å…¨æ€§é«˜**
ä¹‹å‰åœ¨ä½¿ç”¨ npm/yarn çš„æ—¶å€™ï¼Œç”±äº node_module çš„æ‰å¹³ç»“æ„ï¼Œå¦‚æœ A ä¾èµ– Bï¼Œ B ä¾èµ– Cï¼Œé‚£ä¹ˆ A å½“ä¸­æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ C çš„ï¼Œä½†é—®é¢˜æ˜¯ A å½“ä¸­å¹¶æ²¡æœ‰å£°æ˜ C è¿™ä¸ªä¾èµ–ã€‚å› æ­¤ä¼šå‡ºç°è¿™ç§éæ³•è®¿é—®çš„æƒ…å†µã€‚ä½† pnpm è„‘æ´ç‰¹åˆ«å¤§ï¼Œè‡ªåˆ›äº†ä¸€å¥—ä¾èµ–ç®¡ç†æ–¹å¼ï¼Œå¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¿è¯äº†å®‰å…¨æ€§

### pnpm è½¯é“¾æ¥å’Œç¡¬é“¾æ¥

#### æ¦‚å¿µ

åœ¨è®¡ç®—æœºä¸­æˆ‘ä»¬æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½†è¿™ä¸ªæŒ‡é’ˆå¹¶ä¸æ˜¯ç›´æ¥æŒ‡å‘æˆ‘ä»¬åœ¨ç£ç›˜ä¸­å­˜å‚¨æ–‡ä»¶çš„ä½ç½®ï¼Œè€Œæ˜¯æŒ‡å‘ä¸€ä¸ª inode å—ï¼Œinode ä¸­å­˜å‚¨ç€æ–‡ä»¶åœ¨ç£ç›˜ä¸­çš„å„ç§ä¿¡æ¯ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„æ–‡ä»¶éƒ½æ˜¯æŒ‡å‘ å¯¹åº”æ–‡ä»¶çš„ inodeï¼Œæˆ‘ä»¬æŠŠè¿™ç±»é“¾æ¥æˆä¸ºç¡¬é“¾æ¥ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç§é“¾æ¥ï¼Œå®ƒå­˜å‚¨çš„å¹¶ä¸æ˜¯å®é™…çš„å€¼ï¼Œè€Œæ˜¯å¦ä¸€ä¸ªç¡¬é“¾æ¥çš„åœ°å€ï¼Œæˆ‘ä»¬æŠŠè¿™ç±»é“¾æ¥æˆä¸ºè½¯é“¾æ¥ã€‚

![Linux ç¡¬é“¾æ¥ä¸è½¯è¿æ¥](https://pic4.zhimg.com/80/v2-ea1844b57ef254659a11f4e03474a253_1440w.jpg)

#### ç‰¹æ€§

#### ç¡¬é“¾æ¥

- å…·æœ‰ç›¸åŒinodeèŠ‚ç‚¹å·çš„å¤šä¸ªæ–‡ä»¶äº’ä¸ºç¡¬é“¾æ¥æ–‡ä»¶ï¼›
- åˆ é™¤ç¡¬é“¾æ¥æ–‡ä»¶æˆ–è€…åˆ é™¤æºæ–‡ä»¶ä»»æ„ä¹‹ä¸€ï¼Œæ–‡ä»¶å®ä½“å¹¶æœªè¢«åˆ é™¤ï¼›
- åªæœ‰åˆ é™¤äº†æºæ–‡ä»¶å’Œæ‰€æœ‰å¯¹åº”çš„ç¡¬é“¾æ¥æ–‡ä»¶ï¼Œæ–‡ä»¶å®ä½“æ‰ä¼šè¢«åˆ é™¤ï¼›
- ç¡¬é“¾æ¥æ–‡ä»¶æ˜¯æ–‡ä»¶çš„å¦ä¸€ä¸ªå…¥å£ï¼›
- å¯ä»¥é€šè¿‡ç»™æ–‡ä»¶è®¾ç½®ç¡¬é“¾æ¥æ–‡ä»¶æ¥é˜²æ­¢é‡è¦æ–‡ä»¶è¢«è¯¯åˆ ï¼›
- åˆ›å»ºç¡¬é“¾æ¥å‘½ä»¤ ln æºæ–‡ä»¶ ç¡¬é“¾æ¥æ–‡ä»¶ï¼›
- ç¡¬é“¾æ¥æ–‡ä»¶æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå¯ä»¥ç”¨rmåˆ é™¤ï¼›
- å¯¹äºé™æ€æ–‡ä»¶ï¼ˆæ²¡æœ‰è¿›ç¨‹æ­£åœ¨è°ƒç”¨ï¼‰ï¼Œå½“ç¡¬é“¾æ¥æ•°ä¸º0æ—¶æ–‡ä»¶å°±è¢«åˆ é™¤ã€‚æ³¨æ„ï¼šå¦‚æœæœ‰è¿›ç¨‹æ­£åœ¨è°ƒç”¨ï¼Œåˆ™æ— æ³•åˆ é™¤æˆ–è€…å³ä½¿æ–‡ä»¶åè¢«åˆ é™¤ä½†ç©ºé—´ä¸ä¼šé‡Šæ”¾ã€‚
åˆ°å¯¹åº”çš„ .pnpm/[package_name]@version/node_modules/[package_name] ä¸­ã€‚

---
pnpm æœ‰ä¸ªæ ¹ç›®å½•ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¿å­˜åœ¨ user/.pnpm-store ä¸‹ï¼Œpnpm é€šè¿‡ç¡¬é“¾æ¥çš„æ–¹å¼ä¿è¯äº†ç›¸åŒçš„åŒ…ä¸ä¼šè¢«é‡å¤ä¸‹è½½ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å·²ç»åœ¨ repoA ä¸­ä¸‹è½½è¿‡ä¸€æ¬¡ express@4.17.1 ç‰ˆæœ¬ï¼Œé‚£æˆ‘ä»¬åç»­åœ¨ repoB ä¸­å®‰è£… express@4.17.1 çš„æ—¶å€™æ˜¯ä¼šè¢«å¤ç”¨çš„ï¼Œå…·ä½“å°±æ˜¯ repoA ä¸­çš„ express ä¸­çš„æ–‡ä»¶å’Œ repoB ä¸­çš„ express ä¸­çš„æ–‡ä»¶æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ª inodeã€‚

```
ç¡¬è¿æ¥æµ‹è¯•
åˆ›å»ºä¸¤ä¸ªç›¸åŒçš„é¡¹ç›® `npm-yarn-pnpm`ã€`npm-yarn-pnpm-hardLink`
åˆ†åˆ«ç”¨pnpm å®‰è£…ä¾èµ– `pnpm install`
åŒæ—¶åˆ°å…¶ä¸­ä¸€ä¸ªåŒ…ï¼Œ ä¾‹å¦‚ `react-router`
`cd node_modules/react-router`
`ls -li` æŸ¥çœ‹æ–‡ä»¶id
```
![WechatIMG204.png](./WechatIMG204.png)
#### è½¯é“¾æ¥

- è½¯é“¾æ¥ç±»ä¼¼windowsç³»ç»Ÿçš„å¿«æ·æ–¹å¼ï¼›
- è½¯é“¾æ¥é‡Œé¢å­˜æ”¾çš„æ˜¯æºæ–‡ä»¶çš„è·¯å¾„ï¼ŒæŒ‡å‘æºæ–‡ä»¶ï¼›
- åˆ é™¤æºæ–‡ä»¶ï¼Œè½¯é“¾æ¥ä¾ç„¶å­˜åœ¨ï¼Œä½†æ— æ³•è®¿é—®æºæ–‡ä»¶å†…å®¹ï¼›
- è½¯é“¾æ¥å¤±æ•ˆæ—¶ä¸€èˆ¬æ˜¯ç™½å­—çº¢åº•é—ªçƒï¼›
- åˆ›å»ºè½¯é“¾æ¥å‘½ä»¤ ln -s æºæ–‡ä»¶ è½¯é“¾æ¥æ–‡ä»¶ï¼›
- è½¯é“¾æ¥å’Œæºæ–‡ä»¶æ˜¯ä¸åŒçš„æ–‡ä»¶ï¼Œæ–‡ä»¶ç±»å‹ä¹Ÿä¸åŒï¼Œinodeå·ä¹Ÿä¸åŒï¼›
- è½¯é“¾æ¥çš„æ–‡ä»¶ç±»å‹æ˜¯â€œlâ€ï¼Œå¯ä»¥ç”¨rmåˆ é™¤ã€‚

---
ä¾‹å¦‚, ç”¨`pnpm` å®‰è£… `express`, 
åœ¨ `node_modules` ç›®å½•ä¸­ è¾“å…¥ `l` æŸ¥çœ‹
![express çš„è½¯è¿æ¥](https://pic1.zhimg.com/80/v2-2bd21c268fb8d11e175c8906b0a94a44_1440w.png)
æ‰€ä»¥è¯´ pnpm çš„è½¯é“¾æ¥å°±æ˜¯å°† node_modules é‡Œçš„æ–‡ä»¶è½¯é“¾æ¥



### ä½¿ç”¨

è¯´äº†è¿™ä¹ˆå¤šï¼Œä¼°è®¡ä½ ä¼šè§‰å¾— `pnpm` æŒºå¤æ‚çš„ï¼Œæ˜¯ä¸æ˜¯ç”¨èµ·æ¥æˆæœ¬å¾ˆé«˜å‘¢ï¼Ÿ
æ°å¥½ç›¸åï¼Œpnpm ä½¿ç”¨èµ·æ¥ååˆ†ç®€å•ï¼Œå¦‚æœä½ ä¹‹å‰æœ‰ npm/yarn çš„ä½¿ç”¨ç»éªŒï¼Œç”šè‡³å¯ä»¥æ— ç¼è¿ç§»åˆ° pnpm ä¸Šæ¥ã€‚ä¸ä¿¡æˆ‘ä»¬æ¥ä¸¾å‡ ä¸ªæ—¥å¸¸ä½¿ç”¨çš„ä¾‹å­ã€‚

#### pnpm install

è·Ÿ npm install ç±»ä¼¼ï¼Œå®‰è£…é¡¹ç›®ä¸‹æ‰€æœ‰çš„ä¾èµ–ã€‚ä½†å¯¹äº monorepo é¡¹ç›®ï¼Œä¼šå®‰è£… workspace ä¸‹é¢æ‰€æœ‰ packages çš„æ‰€æœ‰ä¾èµ–ã€‚ä¸è¿‡å¯ä»¥é€šè¿‡ --filter å‚æ•°æ¥æŒ‡å®š packageï¼Œåªå¯¹æ»¡è¶³æ¡ä»¶çš„ package è¿›è¡Œä¾èµ–å®‰è£…ã€‚
å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼Œæ¥è¿›è¡Œå•ä¸ªåŒ…çš„å®‰è£…:

```js
// å®‰è£… axios
pnpm install axios
// å®‰è£… axios å¹¶å°† axios æ·»åŠ è‡³ devDependencies
pnpm install axios -D
// å®‰è£… axios å¹¶å°† axios æ·»åŠ è‡³ dependencies
pnpm install axios -S
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ --filter æ¥æŒ‡å®š packageã€‚

#### pnpm update

æ ¹æ®æŒ‡å®šçš„èŒƒå›´å°†åŒ…æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œmonorepo é¡¹ç›®ä¸­å¯ä»¥é€šè¿‡ --filter æ¥æŒ‡å®š packageã€‚

#### pnpm uninstall

åœ¨ node_modules å’Œ package.json ä¸­ç§»é™¤æŒ‡å®šçš„ä¾èµ–ã€‚monorepo é¡¹ç›®åŒä¸Šã€‚ä¸¾ä¾‹å¦‚ä¸‹:

```
// ç§»é™¤ axios
pnpm uninstall axios --filter package-a
```
## æ€»ç»“
pnpm çš„å‡ºç°å¯¹äº npm å’Œ yarn æ¥è¯´æ˜¯ä¸€ä¸ªæ¯”è¾ƒå½»åº•çš„æ”¹å˜. ä¿ç•™æœ‰åŸæ¥ `node_modules` çš„ä¸€äº›åŸºæœ¬çº¦å®šçš„åŒæ—¶, åˆç”¨è½¯è¿æ¥çš„æ–¹å¼å¯¹ä¸€äº›npm/yarn å­˜åœ¨çš„é—®é¢˜ç»™äºˆè§£å†³.
pnpm ç›®å‰å¯¹äºæ—¥å¸¸ä½¿ç”¨å®Œå…¨æ²¡é—®é¢˜ï¼Œç›®å‰å¾ˆå¤šçš„ç±»åº“è¿˜æœ‰æ¡†æ¶éƒ½å·²ç»é»˜è®¤å°† pnpm ä½œä¸ºå®‰è£…å·¥å…·ï¼Œç›®å‰çœ‹æ¥ pnpm å®Œå…¨å¯ä»¥å–ä»£ npmã€‚
æˆ–è®¸pnpm è¿˜æœ‰ä¸€äº›éœ€è¦å®Œå–„çš„é—®é¢˜, ä¾‹å¦‚è½¯è¿æ¥å¯¼è‡´çš„ä¸€äº›åŒ…éœ€å‡çº§æ‰èƒ½ä½¿ç”¨pnpmç­‰, ä½† pnpm çš„å‡ºç°å¹¶ä¸æ˜¯å¦ä¸€ä¸ªåŒ…ç®¡ç†å™¨çš„ç«å“, è€Œæ˜¯ä¸€ä¸ªæœ€ä½³è§£å†³æ–¹æ¡ˆçš„æ¢ç´¢.



## ni - ä¸€ä¸ªå°å·¥å…·ä»‹ç»
> é¢å¯¹ npm / yarn / pnpmï¼Œ å¯èƒ½æˆ‘ä»¬éœ€è¦æ ¹æ®ä¸åŒåœºæ™¯å»é€‰æ‹©ä¸åŒçš„å·¥å…·æ¥æ›´é«˜æ•ˆå¼€å‘ï¼Œ æ‰€ä»¥å°±æœ‰äº† `ni`

### å‰è¨€

å½“æˆ‘ä»¬çœ‹ [vue3 ä»“åº“](https://github.com/vuejs/core/blob/main/.github/contributing.md#development-setup) æ—¶ï¼Œ å‘ç° vue3 å»ºè®®ä½¿ç”¨ `pnpm` æ¥å®‰è£…ä¾èµ–ï¼Œ å¹¶æ¨èå®‰è£… `ni` ä»¥å¸®åŠ©åœ¨ä¸åŒçš„åŒ…ç‰ˆæœ¬ç®¡ç†å™¨ä¹‹é—´åˆ‡æ¢ã€‚

### ç‰¹ç‚¹

- ä½¿ç”¨`TypeScript`ä½œä¸ºå¼€å‘è¯­è¨€
- æ ¸å¿ƒä»£ç ä»…ä»…ä¸€ç™¾å¤šè¡Œ

### ni åšäº†ä»€ä¹ˆ

1. æ ¹æ®é”æ–‡ä»¶çŒœæµ‹ç”¨å“ªä¸ªåŒ…ç®¡ç†å™¨ npm/yarn/pnpm - [detect å‡½æ•°](https://github.com/antfu/ni/src/detect.ts)

2. æŠ¹å¹³ä¸åŒçš„åŒ…ç®¡ç†å™¨çš„å‘½ä»¤å·®å¼‚ - [parseNi å‡½æ•°](https://github.com/antfu/ni/src/commands.ts)

3. æœ€ç»ˆè¿è¡Œç›¸åº”çš„è„šæœ¬ - [execa å·¥å…·](https://github.com/sindresorhus/execa)
   

4. æ‰¾åˆ°é¡¹ç›®æ ¹è·¯å¾„ä¸‹çš„é”æ–‡ä»¶ã€‚è¿”å›å¯¹åº”çš„åŒ…ç®¡ç†å™¨ `npm/yarn/pnpm`ã€‚

5. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œé‚£å°±è¿”å› `null`ã€‚

6. å¦‚æœæ‰¾åˆ°äº†ï¼Œä½†æ˜¯ç”¨æˆ·ç”µè„‘æ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œåˆ™è¯¢é—®ç”¨æˆ·æ˜¯å¦è‡ªåŠ¨å®‰è£…ã€‚


### ä½¿ç”¨

å…¨å±€å®‰è£…

```shell
npm i -g @antfu/ni
```

install

```shell
ni
# npm install
# yarn install
# pnpm install
```

add

```shell
ni axios
# npm i axios
# yarn add axios
# pnpm add axios
```

### çŒœä¸€çŒœ

**å¦‚æœ package-lock.json,yarn.lock,pnpm-lock.yaml éƒ½å­˜åœ¨çš„è¯ï¼ŒæŒ‰å“ªä¸ªæ‰§è¡Œå‘¢ï¼Ÿ**

```ts
// ni/src/agents.ts
export const LOCKS: Record<string, Agent> = {
  'pnpm-lock.yaml': 'pnpm',
  'yarn.lock': 'yarn',
  'package-lock.json': 'npm',
}
```

## å‚è€ƒèµ„æ–™

- [npm-å®˜ç½‘](https://www.npmjs.com/)
- [npm-æ˜é‡‘](https://juejin.cn/post/6844903870578032647)
- [npm å’Œ yarn ä½ é€‰å“ªä¸ªï¼Ÿ](https://juejin.cn/post/6844904030741921800)
- [yarn 1 æ–‡æ¡£](https://classic.yarnpkg.com/lang/en/)
- [yarn 2 æ–‡æ¡£](https://yarnpkg.com/getting-started/migration) 
- [pnpm å®˜ç½‘](https://pnpm.io/zh/installation)
- [Yarn 2å°é²œ](https://juejin.cn/post/6896447858841681928)
- [å­—èŠ‚çš„ä¸€ä¸ªå°é—®é¢˜ npm å’Œ yarnä¸ä¸€æ ·å—ï¼Ÿ](https://juejin.cn/post/7060844948316225572)
- [ä»0åˆ°0.5åˆ›å»ºä¸€ä¸ªmonoreposé¡¹ç›®](https://juejin.cn/post/6844904142477983751)
- [Why should we use pnpm?](https://www.kochan.io/nodejs/why-should-we-use-pnpm.html)
- [JavaScript package managers compared: npm, Yarn, or pnpm?](https://blog.logrocket.com/javascript-package-managers-compared/)
- [Pnpm: æœ€å…ˆè¿›çš„åŒ…ç®¡ç†å·¥å…·](https://zhuanlan.zhihu.com/p/404784010)
- [Flat node_modules is not the only way](https://pnpm.io/blog/2020/05/27/flat-node-modules-is-not-the-only-way)
- [ä»npm åˆ° yarn å†åˆ° pnpm â€”â€” ä¸ºä»€ä¹ˆè¦ä½¿ç”¨pnpmï¼Ÿ](https://juejin.cn/post/7077918263954374670)